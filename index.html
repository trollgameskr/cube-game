<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="2x2부터 7x7까지 다양한 크기의 큐브 퍼즐 게임 - GitHub Pages용 웹앱">
    <meta name="theme-color" content="#2b3a67">
    <title>큐브 퍼즐 게임</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
</head>
<body>
    <button type="button" id="focus-exit-btn" aria-label="집중 모드 종료">집중 모드 종료 (Esc)</button>
    <div class="app">
        <header class="app-header">
            <h1>3D 큐브 게임</h1>
            <p>큐브를 드래그해 면을 회전하고, 빈 공간을 드래그해 큐브를 회전하세요. 마우스 휠로 확대/축소할 수 있습니다. 2x2부터 7x7까지 다양한 크기의 큐브를 즐겨보세요!</p>
        </header>

        <main class="app-main">
            <section class="cube-section" aria-labelledby="cube-title">
                <h2 id="cube-title" class="sr-only">3D 큐브</h2>
                <div class="cube-stage" id="cube-stage">
                    <button type="button" id="back-view-btn" class="back-view-btn" aria-label="뒷면 보기 (누르고 있기)">👁️</button>
                    <div id="game-timer" class="game-timer" style="display: none;">00:00</div>
                </div>
                <p class="cube-hint">큐브 위를 드래그하면 면 회전, 빈 공간을 드래그하면 큐브 전체가 회전 (수평 드래그 → 수직축, 수직 드래그 → 수평축), 마우스 휠로 줌이 가능합니다.</p>
            </section>

            <section class="control-section" aria-labelledby="control-title">
                <h2 id="control-title" class="sr-only">조작 패널</h2>

                <div class="hud">
                    <div class="hud-item">이동 수 <strong id="move-count">0</strong></div>
                    <div class="hud-item">최근 이동 <span id="move-log">-</span></div>
                </div>

                <div id="message" class="message">섞기 버튼으로 게임을 시작하세요!</div>

                <div class="actions">
                    <button type="button" id="scramble-btn" class="btn primary">섞기</button>
                    <button type="button" id="reset-btn" class="btn">리셋</button>
                    <button type="button" id="hint-btn" class="btn">힌트</button>
                    <button type="button" id="guide-btn" class="btn">가이드</button>
                    <button type="button" id="focus-btn" class="btn">집중 모드</button>
                </div>

                <div class="speed-control">
                    <label for="speed-slider">회전 속도: <span id="speed-value">200ms</span></label>
                    <input type="range" id="speed-slider" min="50" max="1000" value="200" step="50">
                </div>

                <div class="cube-size-control">
                    <label for="cube-size-select">큐브 크기:</label>
                    <select id="cube-size-select" class="cube-size-select">
                        <option value="2">2x2</option>
                        <option value="3" selected>3x3</option>
                        <option value="4">4x4</option>
                        <option value="5">5x5</option>
                        <option value="6">6x6</option>
                        <option value="7">7x7</option>
                    </select>
                </div>

                <div class="cube-type-control">
                    <label for="cube-type-select">큐브 타입:</label>
                    <select id="cube-type-select" class="cube-type-select">
                        <option value="normal" selected>일반 큐브</option>
                        <option value="mirror">미러 큐브</option>
                    </select>
                </div>

                <div class="hotkeys">
                    <h3>단축키 안내</h3>
                    <p>U, D, L, R, F, B 키로 면 회전 • Shift+키는 반시계 방향 • Space로 최근 메시지 확인 • T로 뒷면 보기 토글 • Esc로 집중 모드 전환</p>
                    <button type="button" id="customize-keys-btn" class="btn btn-small">단축키 커스터마이징</button>
                </div>
            </section>
        </main>

        <!-- Leaderboard Section -->
        <section class="leaderboard-section" aria-labelledby="leaderboard-title">
            <h2 id="leaderboard-title">🏆 글로벌 순위</h2>
            <p class="leaderboard-description">모든 기기에서 공유되는 최고 기록들입니다!</p>
            
            <div id="leaderboard-status" class="leaderboard-status">
                순위표 불러오는 중...
            </div>
            
            <div id="leaderboard-list" class="leaderboard-list">
                <!-- Leaderboard entries will be inserted here -->
            </div>
            
            <div class="leaderboard-actions">
                <button type="button" id="refresh-leaderboard-btn" class="btn btn-small">새로고침</button>
            </div>
        </section>

        <footer class="app-footer">
            <small>정적 파일만으로 동작하므로 GitHub Pages에 바로 배포할 수 있습니다.</small>
        </footer>
    </div>

    <!-- Keyboard Customization Modal -->
    <div id="keyboard-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>단축키 커스터마이징</h2>
                <button type="button" id="close-modal-btn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-instruction">각 기능에 원하는 키를 할당하려면 입력 필드를 클릭하고 키를 누르세요.</p>
                
                <div class="key-mapping-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; margin-bottom: 1rem;">
                    <label style="flex: 1;">카메라 기준 회전 모드:</label>
                    <input type="checkbox" id="camera-relative-mode" style="width: auto; cursor: pointer;">
                    <span style="margin-left: 0.5rem; opacity: 0.7; font-size: 0.9rem;">
                        (켜짐: 카메라 시점 기준, 꺼짐: 고정 축 기준)
                    </span>
                </div>
                
                <div class="key-mapping-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; margin-bottom: 1rem;">
                    <label style="flex: 1;">시작시 자동 섞기:</label>
                    <input type="checkbox" id="auto-scramble-mode" style="width: auto; cursor: pointer;">
                    <span style="margin-left: 0.5rem; opacity: 0.7; font-size: 0.9rem;">
                        (개발자 테스트용: 꺼두면 섞지 않은 상태로 시작)
                    </span>
                </div>
                
                <div class="key-mapping-list">
                    <div class="key-mapping-item">
                        <label>위(Up) 면 회전:</label>
                        <input type="text" id="key-U" readonly placeholder="키를 누르세요">
                        <span class="key-display" data-key="U"></span>
                    </div>
                    <div class="key-mapping-item">
                        <label>아래(Down) 면 회전:</label>
                        <input type="text" id="key-D" readonly placeholder="키를 누르세요">
                        <span class="key-display" data-key="D"></span>
                    </div>
                    <div class="key-mapping-item">
                        <label>왼쪽(Left) 면 회전:</label>
                        <input type="text" id="key-L" readonly placeholder="키를 누르세요">
                        <span class="key-display" data-key="L"></span>
                    </div>
                    <div class="key-mapping-item">
                        <label>오른쪽(Right) 면 회전:</label>
                        <input type="text" id="key-R" readonly placeholder="키를 누르세요">
                        <span class="key-display" data-key="R"></span>
                    </div>
                    <div class="key-mapping-item">
                        <label>앞(Front) 면 회전:</label>
                        <input type="text" id="key-F" readonly placeholder="키를 누르세요">
                        <span class="key-display" data-key="F"></span>
                    </div>
                    <div class="key-mapping-item">
                        <label>뒤(Back) 면 회전:</label>
                        <input type="text" id="key-B" readonly placeholder="키를 누르세요">
                        <span class="key-display" data-key="B"></span>
                    </div>
                    <div class="key-mapping-item">
                        <label>뒷면 보기 토글:</label>
                        <input type="text" id="key-toggleTransparency" readonly placeholder="키를 누르세요">
                        <span class="key-display" data-key="toggleTransparency"></span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="reset-keys-btn" class="btn">기본값으로 초기화</button>
                    <button type="button" id="save-keys-btn" class="btn primary">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Victory Modal for Nickname Input -->
    <div id="victory-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎉 축하합니다!</h2>
                <button type="button" id="close-victory-modal-btn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p class="victory-message">큐브를 완성했습니다!</p>
                <div class="victory-stats">
                    <div class="victory-stat-item">
                        <span class="victory-stat-label">이동 횟수:</span>
                        <span class="victory-stat-value" id="victory-move-count">0</span>
                    </div>
                    <div class="victory-stat-item">
                        <span class="victory-stat-label">소요 시간:</span>
                        <span class="victory-stat-value" id="victory-time">0:00</span>
                    </div>
                </div>
                <div class="nickname-input-section">
                    <label for="nickname-input">순위표에 등록할 이름:</label>
                    <input type="text" id="nickname-input" maxlength="20" placeholder="닉네임을 입력하세요">
                    <p class="nickname-hint">이름을 입력하고 저장하면 글로벌 순위표에 기록됩니다!</p>
                </div>
                <div class="modal-actions">
                    <button type="button" id="skip-leaderboard-btn" class="btn">건너뛰기</button>
                    <button type="button" id="save-score-btn" class="btn primary">기록 저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guide-modal" class="modal" style="display: none;">
        <div class="modal-content guide-modal-content">
            <div class="modal-header">
                <h2>🧩 큐브 맞추기 단계별 가이드</h2>
                <button type="button" id="close-guide-modal-btn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body guide-modal-body">
                <div class="guide-intro">
                    <p>3x3 큐브를 맞추는 방법을 단계별로 안내합니다. 초보자도 따라할 수 있도록 쉽게 설명되어 있습니다.</p>
                    <p class="guide-note"><strong>참고:</strong> 이 가이드는 초보자용 레이어 방법(Layer by Layer)을 사용합니다.</p>
                </div>

                <div class="guide-section">
                    <h3>📋 기본 개념</h3>
                    <div class="guide-content">
                        <h4>면 표기법</h4>
                        <ul>
                            <li><strong>U (Up)</strong>: 위 면</li>
                            <li><strong>D (Down)</strong>: 아래 면</li>
                            <li><strong>L (Left)</strong>: 왼쪽 면</li>
                            <li><strong>R (Right)</strong>: 오른쪽 면</li>
                            <li><strong>F (Front)</strong>: 앞 면</li>
                            <li><strong>B (Back)</strong>: 뒤 면</li>
                        </ul>
                        <h4>회전 표기법</h4>
                        <ul>
                            <li><strong>U</strong>: 위 면을 시계 방향으로 90도 회전</li>
                            <li><strong>U'</strong>: 위 면을 반시계 방향으로 90도 회전 (Shift+U)</li>
                            <li><strong>U2</strong>: 위 면을 180도 회전 (U를 두 번)</li>
                        </ul>
                    </div>
                </div>

                <div class="guide-section">
                    <h3>1단계: 흰색 십자가 만들기</h3>
                    <div class="guide-content">
                        <p><strong>목표:</strong> 위쪽 면(흰색)에 십자가 모양을 만들고, 옆면의 색도 맞춥니다.</p>
                        <div class="guide-steps">
                            <div class="guide-step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <p>흰색 모서리 조각을 찾습니다.</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <p>각 흰색 모서리를 위쪽으로 이동시킵니다.</p>
                                    <p class="algorithm">예: F, R, U 등의 조합 사용</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">3</span>
                                <div class="step-content">
                                    <p>옆면의 색이 맞도록 조정합니다.</p>
                                    <p class="algorithm">팁: U 면을 회전하여 위치 조정</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-section">
                    <h3>2단계: 흰색 모서리 맞추기</h3>
                    <div class="guide-content">
                        <p><strong>목표:</strong> 첫 번째 층을 완성합니다 (흰색 면 전체).</p>
                        <div class="guide-steps">
                            <div class="guide-step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <p>흰색 모서리 조각을 아래층에서 찾습니다.</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <p>모서리 조각을 알맞은 위치 아래로 이동합니다.</p>
                                    <p class="algorithm">기본 공식: R U R' U'</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">3</span>
                                <div class="step-content">
                                    <p>모든 4개의 모서리를 반복합니다.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-section">
                    <h3>3단계: 중간층 맞추기</h3>
                    <div class="guide-content">
                        <p><strong>목표:</strong> 두 번째 층의 모서리를 맞춥니다.</p>
                        <div class="guide-steps">
                            <div class="guide-step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <p>위쪽 층에서 노란색이 없는 모서리를 찾습니다.</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <p><strong>왼쪽으로 이동:</strong></p>
                                    <p class="algorithm">U' L' U L U F U' F'</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">3</span>
                                <div class="step-content">
                                    <p><strong>오른쪽으로 이동:</strong></p>
                                    <p class="algorithm">U R U' R' U' F' U F</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-section">
                    <h3>4단계: 노란색 십자가 만들기</h3>
                    <div class="guide-content">
                        <p><strong>목표:</strong> 위쪽 면(현재 노란색)에 십자가를 만듭니다.</p>
                        <div class="guide-steps">
                            <div class="guide-step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <p>현재 패턴을 확인합니다 (점, L자, 선 또는 십자).</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <p><strong>기본 공식:</strong></p>
                                    <p class="algorithm">F R U R' U' F'</p>
                                    <p>필요에 따라 1~3번 반복</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-section">
                    <h3>5단계: 노란색 면 완성</h3>
                    <div class="guide-content">
                        <p><strong>목표:</strong> 노란색 면 전체를 완성합니다.</p>
                        <div class="guide-steps">
                            <div class="guide-step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <p>노란색 모서리의 위치를 확인합니다.</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <p><strong>공식:</strong></p>
                                    <p class="algorithm">R U R' U R U2 R'</p>
                                    <p>모든 모서리가 노란색이 될 때까지 반복</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-section">
                    <h3>6단계: 모서리 위치 맞추기</h3>
                    <div class="guide-content">
                        <p><strong>목표:</strong> 마지막 층의 모서리를 올바른 위치에 배치합니다.</p>
                        <div class="guide-steps">
                            <div class="guide-step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <p>올바른 위치의 모서리를 찾습니다.</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <p><strong>공식:</strong></p>
                                    <p class="algorithm">U R U' L' U R' U' L</p>
                                    <p>필요에 따라 반복</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-section">
                    <h3>7단계: 마지막 층 완성</h3>
                    <div class="guide-content">
                        <p><strong>목표:</strong> 모든 모서리를 올바른 방향으로 돌려 큐브를 완성합니다.</p>
                        <div class="guide-steps">
                            <div class="guide-step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <p>완성된 면이 앞쪽을 향하도록 큐브를 잡습니다.</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <p><strong>시계 방향 회전:</strong></p>
                                    <p class="algorithm">R' D' R D (반복)</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <span class="step-number">3</span>
                                <div class="step-content">
                                    <p>각 모서리가 맞을 때까지 반복합니다.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-section">
                    <h3>💡 추가 팁</h3>
                    <div class="guide-content">
                        <ul>
                            <li>천천히 시작하세요. 처음에는 한 단계씩 완벽하게 익히는 것이 중요합니다.</li>
                            <li>공식을 외우기보다는 이해하려고 노력하세요.</li>
                            <li>매일 조금씩 연습하면 빠르게 실력이 늘어납니다.</li>
                            <li>온라인 비디오 튜토리얼과 함께 보면 더 도움이 됩니다.</li>
                            <li>이 게임에서 직접 공식을 연습해보세요!</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration - using a demo project
        const firebaseConfig = {
            apiKey: "AIzaSyBNCTDhSV9l69OKA9ZuAX1wvcsJMtrFbOU",
            authDomain: "cube-github.firebaseapp.com",
            projectId: "cube-github",
            storageBucket: "cube-github.firebasestorage.app",
            messagingSenderId: "386970660236",
            appId: "1:386970660236:web:ef0708e03e3103cae0faa9"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make db available globally
        window.firebaseDb = db;
    </script>
    
    <script type="module" src="lib/three-global.js"></script>
    <script src="game.js" defer></script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/cube-game/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
